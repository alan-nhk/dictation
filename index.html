<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dictation Helper Â· æ·ºè‰²ç¾ä»£UI</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f6f7fb;--card:#ffffff;--text:#0f172a;--muted:#64748b;--primary:#5b6cff;--primary-600:#4a5af7;--primary-700:#3a49df;--ring:#e5e7eb;--shadow:0 10px 30px rgba(30,41,59,.12);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;font-family:Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans TC", sans-serif;color:var(--text);background:var(--bg)}
    .wrap{max-width:1080px;margin:0 auto;padding:20px}
    .topbar{position:sticky;top:0;z-index:40;background:linear-gradient(to bottom, rgba(246,247,251,.95), rgba(246,247,251,.7));backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid var(--ring)}
    .topbar-inner{max-width:1080px;margin:0 auto;display:flex;align-items:center;gap:12px;padding:14px 20px}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:12px;background:#eef2ff;color:#4338ca;font-weight:800}
    .title{font-size:20px;font-weight:800}

    .grid{display:grid;grid-template-columns:1.2fr 1fr;gap:18px}
    @media (max-width: 860px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;border:1px solid var(--ring)}
    .card h3{margin:0 0 10px;font-size:15px;letter-spacing:.2px}

    textarea{width:100%;min-height:320px;border:1.5px solid var(--ring);border-radius:12px;padding:14px 12px;background:#fbfcff;color:var(--text);font-size:16px;line-height:1.6;outline:none;transition:border .2s}
    textarea:focus{border-color:#c7d2fe;box-shadow:0 0 0 4px rgba(91,108,255,.12)}
    .counter{font-size:12px;color:var(--muted);margin-top:8px;text-align:right}

    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .row>div{flex:1 1 180px}

    .select{position:relative}
    select,input[type=number]{width:100%;padding:12px 14px;border:1.5px solid var(--ring);border-radius:12px;background:#fbfcff;font-size:15px;color:var(--text);outline:none}
    select:focus,input[type=number]:focus{border-color:#c7d2fe;box-shadow:0 0 0 4px rgba(91,108,255,.12)}

    .slider{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
    input[type=range]{width:100%}
    .chip{font-size:12px;color:#4f46e5;background:#eef2ff;border:1px solid #e0e7ff;padding:4px 8px;border-radius:999px;font-weight:700}

    .seg{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
    .seg button{padding:10px 0;border:1.5px solid var(--ring);border-radius:10px;background:#fff;font-weight:700;cursor:pointer;transition:all .15s}
    .seg button.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .seg button:hover{transform:translateY(-1px)}

    .actions{position:sticky;bottom:12px;z-index:30;display:flex;justify-content:center;margin-top:20px}
    .start{display:flex;align-items:center;gap:10px;background:var(--primary);color:#fff;border:none;padding:14px 22px;border-radius:28px;font-weight:800;box-shadow:0 10px 24px rgba(91,108,255,.35);cursor:pointer;transition:transform .1s, filter .2s}
    .start:hover{filter:brightness(1.05)}
    .start:active{transform:translateY(1px)}
    .btn{padding:12px 16px;border-radius:12px;border:1px solid var(--ring);background:#fff;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn.warn{background:#ef4444;color:#fff;border-color:#ef4444}

    .display{margin-top:18px;background:linear-gradient(180deg,#fff, #f6f7fb);border-radius:22px;border:1px solid var(--ring);box-shadow:var(--shadow);padding:22px;text-align:center}
    .status{display:inline-flex;gap:8px;align-items:center;border:1px solid #eaeaea;background:#fff;border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted);font-weight:800}
    .word{font-size:48px;font-weight:900;margin:10px 0 6px;color:#111827;text-shadow:0 2px 10px rgba(0,0,0,.08);min-height:58px}
    .sub{font-size:16px;color:#6b7280;min-height:22px}
    .bar{height:10px;background:#edf2ff;border-radius:8px;overflow:hidden;margin-top:16px;border:1px solid #e0e7ff}
    .bar>i{display:block;height:100%;background:linear-gradient(90deg,#6e7bff,#5b6cff);width:0%;transition:width .45s ease}

    .panel{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:900px){.panel{grid-template-columns:1fr}}

    .grid-words{display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:8px}
    .grid-words button{padding:9px 12px;border:1px dashed #e5e7eb;background:#fff;border-radius:999px;cursor:pointer;transition:all .12s;font-weight:700;color:#374151}
    .grid-words button:hover{background:#f0f4ff;border-color:#c7d2fe}

    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="badge">ğŸ”Š é»˜æ›¸å¹«æ‰‹</div>
      <div class="title">æ·ºè‰²ç¾ä»£ UI</div>
      <div style="margin-left:auto" class="muted" id="readyHint">è¼‰å…¥èªéŸ³ä¸­â€¦</div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <div class="card">
        <h3>1ï¸âƒ£ è¼¸å…¥å…§å®¹</h3>
        <textarea id="ta" placeholder="æ¯è¡Œä¸€å€‹è©èª
å°‹å¯¶
è¶…ç´šå¸‚å ´
apple
banana"></textarea>
        <div class="counter" id="counter">0 å€‹è©èª</div>
      </div>

      <div class="card">
        <h3>âš™ï¸ è¨­å®šåƒæ•¸</h3>
        <div class="row" style="margin-bottom:10px">
          <div>
            <label>èªéŸ³é¸æ“‡</label>
            <div class="select">
              <select id="selVoice"></select>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="slider">
            <div>
              <label>èªé€Ÿ</label>
              <input type="range" id="rate" min="0.7" max="1.3" step="0.1" value="1.0" />
            </div>
            <span class="chip" id="rateChip">1.0Ã—</span>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div class="slider">
            <div>
              <label>é–‹å§‹å‰å€’æ•¸</label>
              <input type="range" id="countdown" min="0" max="10" step="1" value="3" />
            </div>
            <span class="chip" id="cdChip">3 ç§’</span>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div>
            <label>åŒè©é–“éš”</label>
            <select id="repeatGap"></select>
          </div>
          <div>
            <label>è©èªé–“éš”</label>
            <select id="wordGap"></select>
          </div>
        </div>
        <div style="margin-top:12px">
          <label>æ¯å€‹è©é‡è¤‡æ¬¡æ•¸</label>
          <div class="seg" id="segRepeat"></div>
        </div>
      </div>
    </div>

    <div class="actions">
      <button id="btnStart" class="start">â–¶ é–‹å§‹é»˜æ›¸</button>
    </div>

    <div id="display" class="display" style="display:none">
      <div class="status" id="status">å¾…å‘½</div>
      <div class="word" id="bigWord"></div>
      <div class="sub" id="subText"></div>
      <div class="bar"><i id="barInner"></i></div>
    </div>

    <div class="panel">
      <div class="card">
        <h3>âœ¨ å¿«é€Ÿæ’æ’­ï¼ˆé»æ“Šä»»ä½•è©èªï¼‰</h3>
        <div id="grid" class="grid-words"></div>
        <div class="muted" style="margin-top:8px">æ’æ’­æœƒç«‹å³æ‰“æ–·ç•¶å‰æœ—è®€ï¼›æ’æ’­å®Œæˆå¾ŒæœƒæŒ‰åŸæœ¬é€²åº¦ç¹¼çºŒï¼ˆç”±ç•¶å‰é‡è¤‡æ¬¡æ•¸çš„ä¸‹ä¸€æ¬¡é–‹å§‹ï¼‰ã€‚</div>
      </div>
      <div class="card">
        <h3>ğŸ› æ§åˆ¶</h3>
        <div class="row">
          <button class="btn" id="btnPause" disabled>â¸ æš«åœ</button>
          <button class="btn" id="btnResume" disabled>â–¶ ç¹¼çºŒ</button>
          <button class="btn warn" id="btnStop" disabled>â–  åœæ­¢</button>
          <button class="btn" id="btnReset">â†» é‡è¨­</button>
        </div>
        <div class="muted" style="margin-top:8px">è¨­å®šæœƒè‡ªå‹•ä¿å­˜ï¼›æ”¯æ´è¢å¹•å¸¸äº®ï¼ˆWake Lockï¼‰å¦‚ç€è¦½å™¨å¯ç”¨ã€‚</div>
      </div>
    </div>
  </div>

  <script>
    // ====== DOM ======
    const ta = document.getElementById('ta');
    const counter = document.getElementById('counter');
    const selVoice = document.getElementById('selVoice');
    const rate = document.getElementById('rate');
    const rateChip = document.getElementById('rateChip');
    const countdown = document.getElementById('countdown');
    const cdChip = document.getElementById('cdChip');
    const repeatGap = document.getElementById('repeatGap');
    const wordGap = document.getElementById('wordGap');
    const segRepeat = document.getElementById('segRepeat');
    const grid = document.getElementById('grid');
    const readyHint = document.getElementById('readyHint');

    const btnStart = document.getElementById('btnStart');
    const btnPause = document.getElementById('btnPause');
    const btnResume = document.getElementById('btnResume');
    const btnStop = document.getElementById('btnStop');
    const btnReset = document.getElementById('btnReset');

    const display = document.getElementById('display');
    const statusEl = document.getElementById('status');
    const bigWord = document.getElementById('bigWord');
    const subText = document.getElementById('subText');
    const barInner = document.getElementById('barInner');

    // ====== State ======
    const SETTINGS_KEY = 'dictation_modern_v1';
    let voices = [];
    let list = [];
    let repeatN = 2;
    let wakeLock = null;

    // running
    let running = false, paused = false, stopFlag = false;
    let wordIdx = 0, repeatIdx = 1;
    const q = []; // priority queue

    // ====== Helpers ======
    const sleep = (ms)=> new Promise(r=>setTimeout(r, ms));
    const wordsFromText = (t)=> t.split(/\n|,|ï¼Œ|;|ï¼›/).map(s=>s.trim()).filter(Boolean);

    function save(){
      const data = { text: ta.value, rate: rate.value, cd: countdown.value, rg: repeatGap.value, wg: wordGap.value, rn: repeatN, v: selVoice.value };
      try{ localStorage.setItem(SETTINGS_KEY, JSON.stringify(data)); }catch{}
    }
    function load(){
      try{ const raw = localStorage.getItem(SETTINGS_KEY); if(!raw) return; const d = JSON.parse(raw);
        ta.value = d.text ?? ta.value; rate.value = d.rate ?? rate.value; countdown.value = d.cd ?? countdown.value; repeatGap.value = d.rg ?? repeatGap.value; wordGap.value = d.wg ?? wordGap.value; repeatN = d.rn ?? repeatN; }
      catch{}
      rateChip.textContent = rate.value + 'Ã—';
      cdChip.textContent = countdown.value + ' ç§’';
      updateList();
      highlightSeg();
    }

    function updateList(){ list = wordsFromText(ta.value); counter.textContent = list.length + ' å€‹è©èª'; renderGrid(); save(); }
    function renderGrid(){
      grid.innerHTML = '';
      list.forEach(w=>{
        const b = document.createElement('button');
        b.textContent = w; b.onclick = ()=>{ if(running){ q.unshift(w); try{ speechSynthesis.cancel(); }catch{} status('æ’æ’­ï¼š'+w); } };
        grid.appendChild(b);
      })
    }

    function status(s){ statusEl.textContent = s; }

    // selects
    for(let i=1;i<=10;i++){ const o=document.createElement('option');o.value=i;o.textContent=i+' ç§’'; repeatGap.appendChild(o.cloneNode(true)); wordGap.appendChild(o); }
    repeatGap.value = 2; wordGap.value = 3;

    // repeat segment
    for(let i=1;i<=5;i++){ const b=document.createElement('button'); b.textContent=i; b.onclick=()=>{ repeatN=i; highlightSeg(); save(); }; segRepeat.appendChild(b) }
    function highlightSeg(){ [...segRepeat.children].forEach((b,i)=> b.className = ' '+(i+1===repeatN?'active':'')); }

    // sliders label
    rate.addEventListener('input', ()=>{ rateChip.textContent = rate.value+'Ã—'; save(); })
    countdown.addEventListener('input', ()=>{ cdChip.textContent = countdown.value+' ç§’'; save(); })
    repeatGap.addEventListener('change', save); wordGap.addEventListener('change', save);

    ta.addEventListener('input', updateList);

    // voices
    function loadVoices(){
      const vs = speechSynthesis.getVoices();
      if(!vs.length) return;
      voices = vs;
      selVoice.innerHTML = '';
      vs.forEach(v=>{ const o=document.createElement('option'); o.value=v.name; o.textContent=`${v.name} (${v.lang})`; selVoice.appendChild(o) })
      readyHint.textContent = 'å·²å°±ç·’';
      try{ const saved = JSON.parse(localStorage.getItem(SETTINGS_KEY)||'{}'); if(saved && saved.v){ selVoice.value = saved.v; } }catch{}
    }
    window.speechSynthesis.onvoiceschanged = loadVoices; loadVoices();

    // Wake Lock
    async function lock(){ if(!('wakeLock' in navigator)) return; try{ wakeLock = await navigator.wakeLock.request('screen'); }catch{} }
    async function unlock(){ try{ if(wakeLock) await wakeLock.release(); wakeLock=null; }catch{} }
    document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible' && running && !wakeLock) lock(); });

    function speak(text){
      return new Promise(res=>{
        const u = new SpeechSynthesisUtterance(text);
        const v = voices.find(x=>x.name===selVoice.value);
        if(v) u.voice = v;
        u.rate = parseFloat(rate.value)||1.0; u.onend=res; u.onerror=res; speechSynthesis.speak(u);
      })
    }

    // ====== Engine ======
    async function run(){
      if(!list.length){ alert('è«‹å…ˆè¼¸å…¥è©èª'); return }
      running = true; paused=false; stopFlag=false; wordIdx=0; repeatIdx=1;
      btnStart.disabled=true; btnPause.disabled=false; btnStop.disabled=false; btnReset.disabled=true; btnResume.disabled=true; display.style.display='block'; lock();

      // countdown
      let cd = parseInt(countdown.value)||0; for(let t=cd;t>0;t--){ status('å€’æ•¸ '+t); bigWord.textContent=''; barInner.style.width='0%'; await sleep(1000); if(stopFlag) return finish(); }

      status('é–‹å§‹');
      for(wordIdx=0; wordIdx<list.length; wordIdx++){
        const w = list[wordIdx];
        bigWord.textContent = w; repeatIdx = 1;
        while(repeatIdx<=repeatN){
          subText.textContent = `ç¬¬ ${repeatIdx} æ¬¡ (èªé€Ÿ ${rate.value}Ã—)`;
          await speak(w); if(stopFlag) return finish();
          if(q.length){ await processQueue(); }
          if(repeatIdx<repeatN){ await waitWithPause(parseInt(repeatGap.value)*1000); if(stopFlag) return finish(); }
          repeatIdx++;
        }
        // é€²åº¦
        barInner.style.width = (((wordIdx+1)/Math.max(list.length,1))*100).toFixed(1)+'%';
        if(wordIdx<list.length-1){ subText.textContent = `ä¸‹ä¸€å€‹å‰ç­‰å¾… ${wordGap.value} ç§’`; await waitWithPause(parseInt(wordGap.value)*1000); if(stopFlag) return finish(); }
      }
      status('å®Œæˆ'); subText.textContent='å…¨éƒ¨å®Œæˆ'; btnReset.disabled=false; btnPause.disabled=true; btnStop.disabled=true; btnResume.disabled=true; running=false; unlock();
    }

    async function processQueue(){
      while(q.length){ const w=q.shift(); status('æ’æ’­ï¼š'+w); bigWord.textContent=w; for(let r=1;r<=repeatN;r++){ subText.textContent = `æ’æ’­ç¬¬ ${r} æ¬¡`; await speak(w); if(stopFlag) return; if(r<repeatN) await waitWithPause(parseInt(repeatGap.value)*1000); } }
      status('è¿”å›ä¸»ç·š');
    }

    async function waitWithPause(ms){
      const end = Date.now()+ms; while(Date.now()<end){ if(stopFlag) return; if(paused){ await sleep(130); } else { await sleep(35); } }
    }

    function finish(){ running=false; btnStart.disabled=false; btnPause.disabled=true; btnResume.disabled=true; btnStop.disabled=true; btnReset.disabled=false; unlock(); status('å·²åœæ­¢'); }

    // ====== Events ======
    btnStart.addEventListener('click', run);
    btnPause.addEventListener('click', ()=>{ if(!running) return; paused=true; btnPause.disabled=true; btnResume.disabled=false; status('å·²æš«åœ'); speechSynthesis.pause(); })
    btnResume.addEventListener('click', ()=>{ if(!running) return; paused=false; btnPause.disabled=false; btnResume.disabled=true; status('ç¹¼çºŒ'); speechSynthesis.resume(); })
    btnStop.addEventListener('click', ()=>{ stopFlag=true; speechSynthesis.cancel(); finish(); })
    btnReset.addEventListener('click', ()=>{ if(!confirm('ç¢ºå®šé‡è¨­ï¼Ÿæœƒæ¸…é™¤å·²å­˜è¨­å®šèˆ‡æ–‡å­—')) return; speechSynthesis.cancel(); stopFlag=true; running=false; unlock(); localStorage.removeItem(SETTINGS_KEY); selVoice.selectedIndex=0; rate.value='1.0'; countdown.value='3'; repeatGap.value='2'; wordGap.value='3'; repeatN=2; rateChip.textContent='1.0Ã—'; cdChip.textContent='3 ç§’'; ta.value=''; updateList(); highlightSeg(); display.style.display='none'; status('å¾…å‘½'); subText.textContent=''; barInner.style.width='0%'; })

    selVoice.addEventListener('change', save);

    // init
    updateList(); load();
  </script>
</body>
</html>
